<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma - Plan Estrat√©gico CRUB 2026-2028</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="gantt.css" />
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">Plan Estrat√©gico CRUB</div>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="fundamentacion.html">Fundamentaci√≥n</a></li>
                <li><a href="objetivos.html">Objetivos</a></li>
                <li><a href="normativa.html">Normativa</a></li>
                <li><a href="recursos.html">Recursos</a></li>
                <li><a href="cronograma.html" class="active">Planificaci√≥n</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div class="title-with-button">
            <h1>B.10 Planificaci√≥n</h1>
            <a href="#" class="btn-download" data-pdf-link target="_blank" rel="noopener">üìÑ Ver Propuesta en texto</a>
        </div>

        <p style="text-align: center; margin-bottom: 2rem; color: #6b7280; font-size: 1rem;">Haga clic en cualquier fila para ver detalles completos (metas, acciones e indicadores).</p>

        <div id="og1-card" class="gantt-card" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: center; width: 100%;">
                <div class="canvas-container">
                    <canvas id="ganttCanvas1"></canvas>
                </div>
            </div>
        </div>

        <div id="og2-card" class="gantt-card" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: center; width: 100%;">
                <div class="canvas-container">
                    <canvas id="ganttCanvas2"></canvas>
                </div>
            </div>
        </div>

        <div id="og3-card" class="gantt-card">
            <div style="display: flex; justify-content: center; width: 100%;">
                <div class="canvas-container">
                    <canvas id="ganttCanvas3"></canvas>
                </div>
            </div>
        </div>

    <!-- Modal para detalle de objetivo espec√≠fico -->
    <div id="detailsModal" class="modal-backdrop">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <button class="modal-close" id="modalClose" aria-label="Cerrar">√ó</button>
            </div>
            <div class="modal-body">
                <div>
                    <div class="modal-section-title">Metas</div>
                    <p id="modalMetas" class="modal-section-text"></p>
                </div>
                <div>
                    <div class="modal-section-title">Acciones</div>
                    <p id="modalAcciones" class="modal-section-text"></p>
                </div>
                <div>
                    <div class="modal-section-title">Indicadores</div>
                    <p id="modalIndicadores" class="modal-section-text"></p>
                </div>
                <div>
                    <div class="modal-section-title">Objetivo General</div>
                    <p id="modalObjetivoGeneral" class="modal-section-text"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="planificacion.js"></script>
    <script>
        // --- 1. DATOS (Desde planificacion.json) ---
        let rawData = [];

        document.addEventListener('DOMContentLoaded', () => {
            const a = document.querySelector('[data-pdf-link]');
            if (a && window.SITE_CONFIG?.pdfUrl) a.href = window.SITE_CONFIG.pdfUrl;
        });

        // --- 2. CONFIGURACI√ìN DEL CANVAS ---
        // Dimensiones
        const CONFIG = {
            rowHeight: 52,
            headerHeight: 72,
            sidebarWidth: 340,
            colWidth: 130, // Ancho de un cuatrimestre
            padding: 24,
            fontSize: 14
        };

        // Definici√≥n de columnas temporales (6 cuatrimestres)
        const timeCols = [
            { label: "C1", year: "2026" }, { label: "C2", year: "2026" },
            { label: "C1", year: "2027" }, { label: "C2", year: "2027" },
            { label: "C1", year: "2028" }, { label: "C2", year: "2028" }
        ];

        // Create a canvas for each OG
        function createGanttForOG(ogData, canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Aplanar datos para este OG espec√≠fico
            let flatData = [];
            
            // Insertar cabecera de OG
            flatData.push({
                type: 'og-header',
                ogId: ogData.id,
                ogDescription: ogData.description,
                color: ogData.color
            });
            // Insertar fila de a√±os (sin etiquetas de C1/C2)
            flatData.push({
                type: 'timeline-header',
                kind: 'years-only',
                color: ogData.color
            });
            // Insertar objetivos espec√≠ficos (tareas)
            ogData.specific_objectives.forEach(oe => {
                flatData.push({
                    type: 'task',
                    ogId: ogData.id,
                    ogDescription: ogData.description,
                    id: oe.id,
                    desc: oe.short_desc,
                    timeline: oe.timeline,
                    details: oe.details,
                    metas: oe.metas,
                    acciones: oe.acciones,
                    indicadores: oe.indicadores,
                    color: oe.isCritical ? "#ef4444" : ogData.color,
                    baseColor: ogData.color
                });
            });

            // Calcular tama√±o total
            // Nota: la fila de a√±os es m√°s baja que una fila normal
            const totalWidth = CONFIG.sidebarWidth + (timeCols.length * CONFIG.colWidth);
            const yearsHeaderH = 28;
            const totalHeight = flatData.reduce((sum, row) => {
                if (row.type === 'timeline-header') return sum + yearsHeaderH;
                return sum + CONFIG.rowHeight;
            }, 0);

            // Ajustar resoluci√≥n para nitidez (HiDPI)
            const dpr = window.devicePixelRatio || 1;
            canvas.width = totalWidth * dpr;
            canvas.height = totalHeight * dpr;
            canvas.style.width = totalWidth + "px";
            canvas.style.height = totalHeight + "px";
            ctx.scale(dpr, dpr);

            // Variable para guardar las coordenadas de las barras (para el hover)
            let activeBars = [];
            let hoveredRow = null;

            return { canvas, ctx, flatData, totalWidth, totalHeight, activeBars, hoveredRow };
        }

        // --- 3. FUNCIONES DE DIBUJO ---

        function parseTimeline(timelineStr) {
            const s = String(timelineStr || '').trim();

            // Normalizaci√≥n r√°pida para strings estilo JSON nuevo
            // Ej: "Inicia en 2028" => tratar como 2028
            if (/^inicia\s+en\s+2028/i.test(s)) return { start: 4, span: 2 };

            // Casos soportados (hist√≥ricos)
            if (s === "2026") return { start: 0, span: 2 };
            if (s === "2026-2027 (C1)") return { start: 0, span: 3 };
            if (s === "2026 (C2) - 2027") return { start: 1, span: 3 };
            if (s === "2026 (C2) - 2028") return { start: 1, span: 5 };
            if (s === "2027 (C2) - 2028") return { start: 3, span: 3 };
            if (s === "2026-2027") return { start: 0, span: 4 };
            if (s === "2026-2028") return { start: 0, span: 6 };
            if (s === "2027-2028") return { start: 2, span: 4 };
            if (s === "2028") return { start: 4, span: 2 };

            // Para inputs como "2026-2027" o "2026-2028" sin par√©ntesis
            const m = s.match(/^(\d{4})\s*[-‚Äì]\s*(\d{4})$/);
            if (m) {
                const startYear = Number(m[1]);
                const endYear = Number(m[2]);
                if (startYear === 2026 && endYear === 2027) return { start: 0, span: 4 };
                if (startYear === 2026 && endYear === 2028) return { start: 0, span: 6 };
                if (startYear === 2027 && endYear === 2028) return { start: 2, span: 4 };
            }

            return { start: 0, span: 1 };
        }

        function draw(ganttObj, hoveredIndex = null) {
            const { ctx, flatData, totalWidth, totalHeight, activeBars } = ganttObj;
            
            ctx.clearRect(0, 0, totalWidth, totalHeight);
            ganttObj.activeBars = []; // Resetear zonas activas

            // 1. Dibujar Fondo y Rejilla
            ctx.fillStyle = "#f9fafb";
            ctx.fillRect(0, 0, totalWidth, totalHeight);

            // L√≠neas verticales de cuatrimestres
            ctx.strokeStyle = "#f3f4f6";
            ctx.lineWidth = 1;
            for (let i = 0; i <= timeCols.length; i++) {
                const x = CONFIG.sidebarWidth + (i * CONFIG.colWidth);
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, totalHeight);
                ctx.stroke();
            }

            // 2. Dibujar Filas de Tareas
            let currentY = 0;

            flatData.forEach((item, index) => {
                // L√≠nea divisoria horizontal
                ctx.beginPath();
                ctx.strokeStyle = "#e5e7eb";
                ctx.moveTo(0, currentY);
                ctx.lineTo(totalWidth, currentY);
                ctx.stroke();

                if (item.type === 'og-header') {
                    // Fila de cabecera OG
                    ctx.fillStyle = hexToRgba(item.color, 0.08);
                    ctx.fillRect(0, currentY, totalWidth, CONFIG.rowHeight);

                    // Texto OG
                    ctx.fillStyle = item.color;
                    ctx.font = "bold 15px Segoe UI";
                    ctx.textAlign = "left";

                    const maxWidth = totalWidth - 40;
                    const ogText = item.ogId + ": " + item.ogDescription;
                    const lines = getLines(ctx, ogText, maxWidth);
                    const lineHeight = 18;
                    const startY = currentY + (CONFIG.rowHeight / 2) - ((lines.length - 1) * lineHeight) / 2;

                    lines.forEach((line, i) => {
                        ctx.fillText(line, 20, startY + i * lineHeight);
                    });

                } else if (item.type === 'timeline-header') {
                    // Fila de timeline (solo a√±os)
                    const headerH = 28;
                    ctx.fillStyle = "#f3f4f6";
                    ctx.fillRect(0, currentY, totalWidth, headerH);

                    // Fondo del sidebar en header
                    ctx.fillStyle = "#f3f4f6";
                    ctx.fillRect(0, currentY, CONFIG.sidebarWidth, headerH);

                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.font = "bold 14px Segoe UI";

                    let yearX = CONFIG.sidebarWidth;
                    ["2026", "2027", "2028"].forEach(year => {
                        ctx.fillStyle = "#e5e7eb";
                        ctx.fillRect(yearX, currentY, CONFIG.colWidth * 2, headerH);
                        ctx.strokeStyle = "#d1d5db";
                        ctx.strokeRect(yearX, currentY, CONFIG.colWidth * 2, headerH);
                        ctx.fillStyle = "#374151";
                        ctx.fillText(year, yearX + CONFIG.colWidth, currentY + (headerH / 2));
                        yearX += CONFIG.colWidth * 2;
                    });

                    // Avanzar Y manualmente para esta fila compacta
                    currentY += headerH;
                    return;

                } else if (item.type === 'task') {
                    // Fila de Tarea (OE)
                    const isHovered = hoveredIndex === index;
                    
                    // Subtle highlight on hover
                    if (isHovered) {
                        ctx.fillStyle = hexToRgba(item.baseColor, 0.05);
                        ctx.fillRect(0, currentY, totalWidth, CONFIG.rowHeight);
                    }
                    
                    const centerY = currentY + (CONFIG.rowHeight / 2);

                    // Texto Sidebar (ID + t√≠tulo en la misma l√≠nea)
                    ctx.textAlign = "left"; // Reset text alignment
                    ctx.textBaseline = "alphabetic"; // Reset baseline
                    const textX = 20;
                    const maxTextWidth = CONFIG.sidebarWidth - 40; // padding left+right
                    const lineHeight = 16;
                    const maxLines = 2;

                    const idText = String(item.id || '').trim();
                    const descText = String(item.desc || '').trim();

                    ctx.font = "bold 14px Segoe UI";
                    ctx.fillStyle = "#111827";
                    const idWidth = ctx.measureText(idText).width;

                    ctx.font = "14px Segoe UI";
                    ctx.fillStyle = "#4b5563";
                    const space = idText && descText ? " " : "";
                    const firstLineAvail = Math.max(0, maxTextWidth - (idWidth + (space ? ctx.measureText(space).width : 0)));

                    // Construir l√≠neas, reservando espacio en la primera para el ID
                    const fullLines = getLines(ctx, descText, maxTextWidth);
                    const lines = [];
                    if (fullLines.length > 0) {
                        let first = fullLines[0];
                        if (ctx.measureText(first).width > firstLineAvail) {
                            first = ellipsize(ctx, first, firstLineAvail);
                        }
                        lines.push(first);
                        for (let i = 1; i < fullLines.length && lines.length < maxLines; i++) {
                            lines.push(fullLines[i]);
                        }
                    }
                    if (fullLines.length > maxLines && lines.length > 0) {
                        lines[maxLines - 1] = ellipsize(ctx, lines[maxLines - 1], maxTextWidth);
                    }

                    const usedLineCount = Math.max(1, lines.length);
                    const startY = centerY + 6 - ((usedLineCount - 1) * lineHeight) / 2;

                    // Render: primer rengl√≥n con ID + descripci√≥n al mismo nivel
                    const y0 = startY;
                    let firstLine = (lines[0] ?? "").trim();
                    // ID
                    ctx.font = "bold 14px Segoe UI";
                    ctx.fillStyle = "#111827";
                    if (idText) ctx.fillText(idText + (firstLine ? "." : ""), textX, y0);
                    const renderedId = idText ? (idText + (firstLine ? "." : "")) : "";
                    const renderedIdWidth = renderedId ? ctx.measureText(renderedId + (firstLine ? " " : "")).width : 0;
                    // Descripci√≥n
                    ctx.font = "14px Segoe UI";
                    ctx.fillStyle = "#4b5563";
                    if (firstLine) ctx.fillText(firstLine, textX + renderedIdWidth, y0);

                    // Resto de l√≠neas (si hay)
                    for (let i = 1; i < lines.length; i++) {
                        ctx.fillText(lines[i], textX, y0 + i * lineHeight);
                    }

                    // Dibujar Barra Gantt
                    const timeData = parseTimeline(item.timeline);
                    const barX = CONFIG.sidebarWidth + (timeData.start * CONFIG.colWidth) + 10; // +10 padding
                    const barW = (timeData.span * CONFIG.colWidth) - 20; // -20 padding
                    const barH = 22;
                    const floatOffset = isHovered ? -4 : 0; // Float up by 4px on hover
                    const barY = centerY - (barH / 2) + floatOffset;

                    // Sombra difuminada (m√°s intensa en hover)
                    if (isHovered) {
                        ctx.shadowColor = 'rgba(15, 23, 42, 0.4)';
                        ctx.shadowBlur = 12;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 4;
                    } else {
                        ctx.shadowColor = 'rgba(15, 23, 42, 0.18)';
                        ctx.shadowBlur = 6;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 2;
                    }

                    // Barra Principal con ligero degradado (m√°s vivo en hover)
                    const grad = ctx.createLinearGradient(barX, barY, barX, barY + barH);
                    const base = item.color;
                    const topAlpha = isHovered ? 1 : 0.95;
                    const bottomAlpha = isHovered ? 0.9 : 0.8;
                    grad.addColorStop(0, hexToRgba(base, topAlpha));
                    grad.addColorStop(1, hexToRgba(base, bottomAlpha));
                    ctx.fillStyle = grad;
                    roundRect(ctx, barX, barY, barW, barH, 5);
                    ctx.fill();
                    
                    // Reset shadow
                    ctx.shadowColor = 'transparent';
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;

                    // Borde sutil para cr√≠ticos
                    if (item.color === "#ef4444") {
                        ctx.strokeStyle = "#991b1b";
                        ctx.lineWidth = 1.4;
                        roundRect(ctx, barX, barY, barW, barH, 5);
                        ctx.stroke();
                    }

                    // Guardar coordenadas para interactividad - toda la fila es clickable
                    ganttObj.activeBars.push({
                        x: 0, // Desde el inicio de la fila
                        y: currentY, // Toda la altura de la fila
                        w: totalWidth, // Hasta el final
                        h: CONFIG.rowHeight, // Altura completa de la fila
                        index: index, // Store index for hover tracking
                        data: item
                    });
                }

                currentY += CONFIG.rowHeight;
            });
            
            // Borde final
            ctx.beginPath();
            ctx.strokeStyle = "#e5e7eb";
            ctx.moveTo(0, currentY);
            ctx.lineTo(totalWidth, currentY);
            ctx.stroke();
        }

        // --- 4. INTERACTIVIDAD: CLICK PARA MOSTRAR MODAL ---
        const modalBackdrop = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMetas = document.getElementById('modalMetas');
        const modalAcciones = document.getElementById('modalAcciones');
        const modalIndicadores = document.getElementById('modalIndicadores');
        const modalObjetivoGeneral = document.getElementById('modalObjetivoGeneral');
        const modalCloseBtn = document.getElementById('modalClose');

        function openModal(data) {
            modalTitle.textContent = data.id + ': ' + (data.details || '');
            modalMetas.textContent = data.metas || '';
            modalAcciones.textContent = data.acciones || '';
            modalIndicadores.textContent = data.indicadores || '';
            modalObjetivoGeneral.textContent = (data.ogId || '') + ': ' + (data.ogDescription || '');
            modalBackdrop.classList.add('active');
        }

        function closeModal() {
            modalBackdrop.classList.remove('active');
        }

        modalCloseBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) {
                closeModal();
            }
        });

        // Attach event handlers to all three canvases
        function attachHandlers(ganttObj) {
            const { canvas } = ganttObj;
            
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                let newHoveredRow = null;
                for (const bar of ganttObj.activeBars) {
                    if (mouseX >= bar.x && mouseX <= bar.x + bar.w &&
                        mouseY >= bar.y && mouseY <= bar.y + bar.h) {
                        newHoveredRow = bar.index;
                        break;
                    }
                }

                if (newHoveredRow !== ganttObj.hoveredRow) {
                    ganttObj.hoveredRow = newHoveredRow;
                    canvas.style.cursor = ganttObj.hoveredRow !== null ? 'pointer' : 'default';
                    draw(ganttObj, ganttObj.hoveredRow);
                }
            });

            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                for (const bar of ganttObj.activeBars) {
                    if (mouseX >= bar.x && mouseX <= bar.x + bar.w &&
                        mouseY >= bar.y && mouseY <= bar.y + bar.h) {
                        openModal(bar.data);
                        break;
                    }
                }
            });
        }

        // Helper: Rect√°ngulo redondeado
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        // Helper: Wrapear texto
        function getLines(ctx, text, maxWidth) {
            var words = text.split(" ");
            var lines = [];
            var currentLine = words[0];

            for (var i = 1; i < words.length; i++) {
                var word = words[i];
                var width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        function ellipsize(ctx, text, maxWidth) {
            const s = String(text || '').trim();
            if (ctx.measureText(s).width <= maxWidth) return s;
            const ell = '‚Ä¶';
            let lo = 0;
            let hi = s.length;
            while (lo < hi) {
                const mid = Math.ceil((lo + hi) / 2);
                const candidate = s.slice(0, mid).trimEnd() + ell;
                if (ctx.measureText(candidate).width <= maxWidth) lo = mid;
                else hi = mid - 1;
            }
            const out = s.slice(0, lo).trimEnd();
            return (out ? out : s.slice(0, 1)) + ell;
        }

        // Helper: Convertir Hex a RGBA
        function hexToRgba(hex, alpha) {
            var r = parseInt(hex.slice(1, 3), 16),
                g = parseInt(hex.slice(3, 5), 16),
                b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        async function init() {
            rawData = await getNormalizedPlanData();

            const gantt1 = createGanttForOG(rawData[0], 'ganttCanvas1');
            const gantt2 = createGanttForOG(rawData[1], 'ganttCanvas2');
            const gantt3 = createGanttForOG(rawData[2], 'ganttCanvas3');

            draw(gantt1);
            draw(gantt2);
            draw(gantt3);

            attachHandlers(gantt1);
            attachHandlers(gantt2);
            attachHandlers(gantt3);
        }

        init().catch(err => {
            console.error(err);
            const msg = document.createElement('p');
            msg.style.textAlign = 'center';
            msg.style.color = '#b91c1c';
            msg.style.marginTop = '1rem';
            msg.textContent = 'Error: no se pudo cargar planificacion.json para el cronograma.';
            document.querySelector('main.container')?.appendChild(msg);
        });

    </script>

        <nav class="page-nav" style="max-width: 1200px; margin: 2rem auto 0;">
            <div class="page-nav-container">
                <a href="recursos.html" class="btn-nav btn-nav-prev">
                    <span>Anterior</span>
                    <span class="nav-title">‚Üê Recursos</span>
                </a>
                <a href="index.html" class="btn-nav btn-nav-next">
                    <span>Finalizar</span>
                    <span class="nav-title">Volver al Inicio ‚Üí</span>
                </a>
            </div>
        </nav>
    </main>

    <footer style="margin-top: 2rem;">
        <p>&copy; 2026 Plan Estrat√©gico Administraci√≥n Acad√©mica CRUB - Universidad Nacional del Comahue</p>
    </footer>
    <script src="menu.js"></script>
</body>
</html>